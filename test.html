// 1. QcmController.java - CORRIGÉ
package com.itu.gest_emp.controller;

import com.itu.gest_emp.model.QcmQuestion;
import com.itu.gest_emp.model.Reponse;
import com.itu.gest_emp.service.QcmService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@Controller
@RequestMapping("/qcm")
public class QcmController {

    @Autowired
    private QcmService qcmService;

    @GetMapping("")
    public String showQcmHome(Model model) {
        return "qcm-home";
    }

    @GetMapping("/entreprise-alcool")
    public String showQcmEntrepriseAlcool(Model model) {
        List<QcmQuestion> questions = qcmService.getQuestionsEntrepriseAlcool();
        model.addAttribute("questions", questions);
        model.addAttribute("titre", "QCM - Entreprises Alcoolisées Malagasy");
        return "qcm-quiz";
    }

    @GetMapping("/culture-generale")
    public String showQcmCultureGenerale(Model model) {
        List<QcmQuestion> questions = qcmService.getQuestionsCultureGenerale();
        model.addAttribute("questions", questions);
        model.addAttribute("titre", "QCM - Culture Générale");
        return "qcm-quiz";
    }

    @GetMapping("/mixte")
    public String showQcmMixte(Model model) {
        List<QcmQuestion> questions = qcmService.getRandomQuestions(10);
        model.addAttribute("questions", questions);
        model.addAttribute("titre", "QCM Mixte - Entreprises et Culture Générale");
        return "qcm-quiz";
    }

    @PostMapping("/correction")
    public String processCorrection(@RequestParam Map<String, String> allParams, Model model) {
        int score = 0;
        int total = 0;

        // Compter le nombre total de questions
        total = (int) allParams.keySet().stream()
                .filter(key -> key.startsWith("reponse_"))
                .count();

        // Vérifier chaque réponse
        for (Map.Entry<String, String> entry : allParams.entrySet()) {
            if (entry.getKey().startsWith("reponse_")) {
                try {
                    Long questionId = Long.parseLong(entry.getKey().replace("reponse_", ""));
                    Long reponseId = Long.parseLong(entry.getValue());

                    QcmQuestion question = qcmService.getQuestionById(questionId);
                    if (question != null && question.getReponses() != null) {
                        // Vérifier si la réponse est correcte
                        boolean isCorrect = question.getReponses().stream()
                                .filter(r -> r.getId().equals(reponseId))
                                .findFirst()
                                .map(Reponse::isEstCorrecte)
                                .orElse(false);

                        if (isCorrect) {
                            score++;
                        }
                    }
                } catch (NumberFormatException e) {
                    // Ignorer les paramètres mal formattés
                }
            }
        }

        model.addAttribute("score", score);
        model.addAttribute("total", total);
        return "qcm-result";
    }

    // API REST
    @GetMapping("/api/questions")
    @ResponseBody
    public List<QcmQuestion> getAllQuestionsApi() {
        return qcmService.getAllQuestions();
    }

    @GetMapping("/api/questions/{id}")
    @ResponseBody
    public QcmQuestion getQuestionByIdApi(@PathVariable Long id) {
        return qcmService.getQuestionById(id);
    }

    @GetMapping("/api/questions/categorie/{categorie}")
    @ResponseBody
    public List<QcmQuestion> getQuestionsByCategorieApi(@PathVariable String categorie) {
        return qcmService.getQuestionsByCategorie(categorie);
    }
}

// 2. QcmService.java - CORRIGÉ
package com.itu.gest_emp.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import com.itu.gest_emp.model.QcmQuestion;
import com.itu.gest_emp.repository.QcmQuestionRepository;

import java.util.Arrays;
import java.util.List;

@Service
public class QcmService {

    @Autowired
    private QcmQuestionRepository questionRepository;

    public List<QcmQuestion> getQuestionsEntrepriseAlcool() {
        return questionRepository.findByCategorie("entreprise_alcool");
    }

    public List<QcmQuestion> getQuestionsCultureGenerale() {
        return questionRepository.findByCategorie("culture_generale");
    }

    public List<QcmQuestion> getAllQuestions() {
        return questionRepository.findAll(); // CORRECTION: plus simple
    }

    public List<QcmQuestion> getRandomQuestions(int limit) {
        return questionRepository.findRandomQuestions(limit);
    }

    public QcmQuestion getQuestionById(Long id) {
        return questionRepository.findById(id).orElse(null);
    }

    // CORRECTION: Implémentation de la méthode manquante
    public List<QcmQuestion> getQuestionsByCategorie(String categorie) {
        return questionRepository.findByCategorie(categorie);
    }
}

// 3. QcmQuestionRepository.java - CORRIGÉ
package com.itu.gest_emp.repository;

import com.itu.gest_emp.model.QcmQuestion;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface QcmQuestionRepository extends JpaRepository<QcmQuestion, Long> {
    
    List<QcmQuestion> findByCategorie(String categorie);

    @Query("SELECT q FROM QcmQuestion q WHERE q.categorie IN :categories")
    List<QcmQuestion> findByCategories(@Param("categories") List<String> categories);

    // CORRECTION: Pour PostgreSQL utilisez RANDOM(), pour MySQL utilisez RAND()
    @Query(value = "SELECT * FROM qcm_questions ORDER BY RANDOM() LIMIT :limit", nativeQuery = true)
    List<QcmQuestion> findRandomQuestions(@Param("limit") int limit);
    
    // Alternative pour MySQL si nécessaire :
    // @Query(value = "SELECT * FROM qcm_questions ORDER BY RAND() LIMIT :limit", nativeQuery = true)
}

// 4. QcmQuestion.java - CORRIGÉ
package com.itu.gest_emp.model;

import jakarta.persistence.*;
import java.util.List;
import java.util.ArrayList;

@Entity
@Table(name = "qcm_questions")
public class QcmQuestion {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, columnDefinition = "TEXT")
    private String texte;

    @Column(name = "categorie")
    private String categorie; // "entreprise_alcool" ou "culture_generale"

    // CORRECTION: EAGER fetch pour charger les réponses automatiquement
    @OneToMany(mappedBy = "question", cascade = CascadeType.ALL, fetch = FetchType.EAGER)
    private List<Reponse> reponses = new ArrayList<>();

    // Constructeurs
    public QcmQuestion() {}

    public QcmQuestion(String texte, String categorie) {
        this.texte = texte;
        this.categorie = categorie;
    }

    // Getters et Setters
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public String getTexte() { return texte; }
    public void setTexte(String texte) { this.texte = texte; }

    public String getCategorie() { return categorie; }
    public void setCategorie(String categorie) { this.categorie = categorie; }

    public List<Reponse> getReponses() { return reponses; }
    public void setReponses(List<Reponse> reponses) { this.reponses = reponses; }
}

// 5. Reponse.java - CORRIGÉ
package com.itu.gest_emp.model;

import jakarta.persistence.*;

@Entity
@Table(name = "reponses")
public class Reponse {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, columnDefinition = "TEXT")
    private String texte;

    @Column(name = "est_correcte")
    private boolean estCorrecte;

    // CORRECTION: Suppression de l'import incorrect
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "question_id", nullable = false)
    private QcmQuestion question;

    // Constructeurs
    public Reponse() {}

    public Reponse(String texte, boolean estCorrecte, QcmQuestion question) {
        this.texte = texte;
        this.estCorrecte = estCorrecte;
        this.question = question;
    }

    // Getters et Setters
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public String getTexte() { return texte; }
    public void setTexte(String texte) { this.texte = texte; }

    public boolean isEstCorrecte() { return estCorrecte; }
    public void setEstCorrecte(boolean estCorrecte) { this.estCorrecte = estCorrecte; }

    public QcmQuestion getQuestion() { return question; }
    public void setQuestion(QcmQuestion question) { this.question = question; }
}